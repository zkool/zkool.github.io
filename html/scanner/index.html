<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>H5扫码枪-WEB端</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="vconsole.min.js"></script>
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?63bc2ef27984b3f99d7c9c3cef8d26be";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>

<body>
    <div>
       <span>WebSocket Server wss://</span> <input type="text" id="ws_input" /> <input type="button" value="连接" onclick="connectServer()" id="connect_but" >
       <a href="https://mp.weixin.qq.com/s/TAMKg-UtxGTqg3rNmBqAVg" target="_blank">使用教程</a> | 
       <a href="/html/scanner/pda.html" target="_blank">PDA扫码</a> | 
       <a href="/html/scanner/scanModal.html" target="_blank">手机H5扫一扫</a>
    </div>
    <div>
        <textarea style="width:96%;height: 100px;margin-top: 5px;" id="ws_textarea"></textarea>
    </div>
    <div id="qr-reader" style="width:97.6%"></div>
    <div id="qr-reader-results"></div>
</body>
<script src="html5-qrcode.min.js"></script>
<script src="GS1_Application_Identifiers.js"></script>
<script>
     //初始化一下就可以了，
    let vConsole = new VConsole();
    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

/*
    docReady(function () {
        var resultContainer = document.getElementById('qr-reader-results');
        var lastResult, countResults = 0;
        function onScanSuccess(decodedText, decodedResult) {
            if (decodedText !== lastResult) {
                ++countResults;
                lastResult = decodedText;
                // Handle on success condition with the decoded message.
                console.log(`Scan result ${decodedText}`, decodedResult);
				resultContainer.value = decodedText;
            }
        }

        var html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    });
	*/
	
docReady(function() {
	var lastMessage;
	var codeId = 1;
	function onScanSuccess(decodedText, decodedResult) {
	    console.log('扫描结果decodedText', decodedText);
	    console.log('扫描结果decodedResult', decodedResult);

        /**
         * If you following the code example of this page by looking at the
         * source code of the demo page - good job!!
         * 
         * Tip: update this function with a success callback of your choise.
         */
		if (lastMessage !== decodedText) {
			lastMessage = decodedText;
            printScanResultPretty(codeId, decodedText, decodedResult, ruleBaseList);
            ++codeId;
            sendMsg(decodedText);
		}
	}
    var qrboxFunction = function(viewfinderWidth, viewfinderHeight) {
        // Square QR Box, with size = 80% of the min edge.
        var minEdgeSizeThreshold = 250;
        var edgeSizePercentage = 0.75;
        var minEdgeSize = (viewfinderWidth > viewfinderHeight) ?
            viewfinderHeight : viewfinderWidth;
        var qrboxEdgeSize = Math.floor(minEdgeSize * edgeSizePercentage);
        if (qrboxEdgeSize < minEdgeSizeThreshold) {
            if (minEdgeSize < minEdgeSizeThreshold) {
                return {width: minEdgeSize, height: minEdgeSize};
            } else {
                return {
                    width: minEdgeSizeThreshold,
                    height: minEdgeSizeThreshold
                };
            }
        }
        return {width: qrboxEdgeSize, height: qrboxEdgeSize};
    }
	let html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader", 
        { 
            fps: 10,
            qrbox: qrboxFunction,
            // Important notice: this is experimental feature, use it at your
            // own risk. See documentation in
            // mebjas@/html5-qrcode/src/experimental-features.ts
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            },
            rememberLastUsedCamera: true,
            showTorchButtonIfSupported: true
        });
	html5QrcodeScanner.render(onScanSuccess);
});

//010505047461080420131730031311250313213166032511240ICB00I0225
//]C10250195500913501412087756200797210B212100001
let ruleBaseList = initRuleBase();
// printScanResultPretty(1, ']C10250195500913501412087756200797210B212100001', {result: {format: {formatName:'CODE_128'}}}, ruleBaseList);
// printScanResultPretty(1, '010505047461080420131730031311250313213166032511240ICB00I0225', {result: {format: {formatName:'CODE_128'}}}, ruleBaseList);
// printScanResultPretty(1, 'abgdfsdfds', {result: {format: {formatName:'CODE_128'}}}, ruleBaseList);

function initRuleBase(){
    let result = [];
    let applicationIdentifiersArray = gs1Ais.applicationIdentifiers;
    for(let i=1; i<applicationIdentifiersArray.length; i++){
        let aiObject = applicationIdentifiersArray[i];
        let resultItem = {
            applicationIdentifier: aiObject.applicationIdentifier,
            description: aiObject.description,
            separatorRequired: aiObject.separatorRequired,
            length: aiObject.components[0].length
        };
        result.push(resultItem);
    }
    return result;
}
function decodeGs1Ai(ruleBaseList, barcode, decodeAIList){
    if(!barcode){
        return;
    }
    for (const key in ruleBaseList) {
        const ruleBase = ruleBaseList[key];
         if(barcode.startsWith(ruleBase.applicationIdentifier)){
            let decodeGs1AI = {
                applicationIdentifier: ruleBase.applicationIdentifier,
                description: ruleBase.description,
                separatorRequired: ruleBase.separatorRequired,
                length: ruleBase.length
            }

            let endIndex;
            let nextStartIndex;
            if(ruleBase.separatorRequired){
                endIndex = barcode.indexOf('[GS]');
                if(endIndex == -1){
                    endIndex = barcode.length;
                    nextStartIndex = endIndex;
                }else{
                    nextStartIndex = endIndex + 4;
                }
            }else{
                endIndex = ruleBase.applicationIdentifier.length + ruleBase.length;
                if(barcode.length < endIndex){
                    endIndex = barcode.length;
                }
                nextStartIndex = endIndex;
            }

            if(endIndex > 0){
                decodeGs1AI.content = barcode.substring(ruleBase.applicationIdentifier.length, endIndex);
                decodeAIList.push(decodeGs1AI);
            }

            if(barcode.length > nextStartIndex){
                decodeGs1Ai(ruleBaseList, barcode.substring(nextStartIndex), decodeAIList);
            }
            break;
         }
    }
}

/** Ugly function to write the results to a table dynamically. */
function printScanResultPretty(codeId, decodedText, decodedResult, ruleBaseList) {
    // console.log(decodedText)
    let tempBarcode = decodedText.replaceAll("\u001d", "[GS]").replace("]C1", "");
    if(tempBarcode.startsWith("[GS]")){
        tempBarcode = tempBarcode.substring(4);
    }
    let decodeAIList = [];
    decodeGs1Ai(ruleBaseList, tempBarcode, decodeAIList);
    console.log(decodeAIList);

    let decodedText2 = '';
    for(let key in decodeAIList){
        let gs1Ai = decodeAIList[key];
        decodedText2 += '('+gs1Ai.applicationIdentifier+')'+gs1Ai.content;
    }

	let resultSection = document.getElementById('qr-reader-results');
    let tableBodyId = "scanned-result-table-body";
    if (!document.getElementById(tableBodyId)) {
        let table = document.createElement("table");
        table.className = "table-container";
        //table.style.width = "100%";
        resultSection.appendChild(table);
        let theader = document.createElement('thead');
        let trow = document.createElement('tr');
        let th1 = document.createElement('td');
        th1.innerText = "序号";
        let th2 = document.createElement('td');
        th2.innerText = "类型";
        let th3 = document.createElement('td');
        th3.innerText = "扫码结果";
        let th4 = document.createElement('td');
        th4.innerText = "扫码结果2";
        trow.appendChild(th1);
        trow.appendChild(th2);
        trow.appendChild(th3);
        trow.appendChild(th4);
        theader.appendChild(trow);
        table.appendChild(theader);
        let tbody = document.createElement("tbody");
        tbody.id = tableBodyId;
        table.appendChild(tbody);
    }
    let tbody = document.getElementById(tableBodyId);
    let trow = document.createElement('tr');
    let td1 = document.createElement('td');
    td1.innerText = `${codeId}`;
    let td2 = document.createElement('td');
    td2.innerText = `${decodedResult.result.format.formatName}`;
    let td3 = document.createElement('td');
    td3.innerText = `${decodedText}`;
    let td4 = document.createElement('td');
    td4.innerText = `${decodedText2}`;
    trow.appendChild(td1);
    trow.appendChild(td2);
    trow.appendChild(td3);
    trow.appendChild(td4);
    tbody.appendChild(trow);
}


    var socket;

    function connectServer(){
        var h5_barcode_gun_socket_ip = document.getElementById("ws_input").value;
        if(!h5_barcode_gun_socket_ip){
            h5_barcode_gun_socket_ip = localStorage.getItem("h5_barcode_gun_socket_ip");
            if(h5_barcode_gun_socket_ip){
                document.getElementById("ws_input").value = h5_barcode_gun_socket_ip;
            }
        }
        if(!h5_barcode_gun_socket_ip){
            appendTextarea("请填写WebSocket Server");
            return;
        }

        socket = new WebSocket('wss://'+h5_barcode_gun_socket_ip);
        // socket = new WebSocket('ws://192.168.123.101:2024');
        socket.onopen = function(event){
            appendTextarea("连接WebSocket Server成功!");
            document.getElementById("connect_but").disabled = true;
            localStorage.setItem("h5_barcode_gun_socket_ip", h5_barcode_gun_socket_ip);
        };

        // 监听消息
        socket.onmessage = function(event){
            console.log('Client received a message',event);
            console.log(event.data);
            appendTextarea(event.data);
        };

        // 监听Socket的关闭
        socket.onclose = function(event){

        };

        socket.onerror = function(event) {
            appendTextarea("无法连接到WebSocket Server:" + h5_barcode_gun_socket_ip);
        };
    }

    connectServer()

    function sendMsg(msg){
        socket.send(msg);
        appendTextarea("发送消息:" + msg);
    }

    function appendTextarea(text){
        var ws_textarea = document.getElementById("ws_textarea");
        ws_textarea.value = (ws_textarea.value?ws_textarea.value + "\n":"") + text ;
    }

</script>

<style>
/* 基础表格样式 */
table {
  table-layout: fixed; /* 固定列宽分配 */
  width: 98%;         /* 占满容器宽度 */
  border-collapse: collapse;
  word-break: break-all; /* 强制长单词换行 */
  margin-top: 30px;
  margin-bottom: 80px;
}

/* 单元格样式 */
td, th {
  /*overflow: hidden;          隐藏溢出内容 */
  /*text-overflow: ellipsis;   显示省略号 */
  /*white-space: nowrap;        禁止文本换行 */
  max-width: 100px;         /* 限制最大宽度 */
  padding: 8px;
  border: 1px solid #ddd;
}

/* 移动端适配：小屏幕下允许横向滚动 */
@media (max-width: 768px) {
  .table-container {
    overflow-x: auto;       /* 横向滚动 */
    -webkit-overflow-scrolling: touch; /* 移动端平滑滚动 */
  }
  
  /* 调整列宽策略 */
  td:nth-child(1), th:nth-child(1) { width: 10%; }
  td:nth-child(2), th:nth-child(2) { width: 10%; }
  td:nth-child(3), th:nth-child(3) { width: 40%; }
  td:nth-child(3), th:nth-child(4) { width: 40%; }
}

/* 增强兼容性：处理iOS Safari特殊表现 */
@supports (-webkit-overflow-scrolling: touch) {
  .table-container {
    overflow-x: scroll;
  }
}
</style>

</html>